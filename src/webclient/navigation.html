<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
  .card {
    border-color: #edf2f9;
    box-shadow: 0 0.75rem 1.5rem rgba(18,38,63,.03);
  }
  .card-header {
    padding: 1rem 1.5rem;
    margin-bottom: 0;
    background-color: transparent;
    border-bottom: 1px solid #edf2f9;
  }
  .card-header-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 0;
  }
</style>

<script type="text/javascript" src="dependencies/easeljs.min.js"></script>
<script type="text/javascript" src="dependencies/eventemitter2.min.js"></script>
<script type="text/javascript" src="dependencies/roslib.min.js"></script>
<script type="text/javascript" src="dependencies/ros2d.min.js"></script>
<script type="text/javascript" src="dependencies/vuejs.min.js"></script>
<script type="text/javascript" src="navigation.js"></script>

<script type="text/javascript">
  /**
   * Setup all GUI elements when the page is loaded.
   */
  function init() {

    var app = new Vue({
      el: '#app',
      // storing the state of the page
      data: {
          logs: [],
          ws_address: 'ws://localhost:9090',
          conected: false,
          ros: null,
          viewer: null
      },
      methods: {
        connect: function() {
            this.ros = new ROSLIB.Ros({
                url: this.ws_address
            });
            this.ros.on('connection', () => {
                this.logs.unshift((new Date()).toTimeString() + ' - Connected!')
                this.connected = true
            });
            this.ros.on('error', (error) => {
                this.logs.unshift((new Date()).toTimeString() + ` - Error: ${error}`)
            });
            this.ros.on('close', () => {
                this.logs.unshift((new Date()).toTimeString() + ' - Disconnected!')
                this.connected = false
            });
        },
        createViewer: function() {
          this.viewer = new ROS2D.Viewer({
            divID : 'nav',
            width : 750,
            height : 700
          });
        },
        switchRobot: function() {
          if(window.selectedRobotIndex === 0) {
            window.selectedRobotIndex = 1;
            this.logs.unshift((new Date()).toTimeString() + ' - Selected robot 2')
          } else {
            window.selectedRobotIndex = 0;
            this.logs.unshift((new Date()).toTimeString() + ' - Selected robot 1')
          }
        },
        startPatrol: function() {
          if(window.selectedRobotIndex === 0) {
            this.logs.unshift((new Date()).toTimeString() + ' - Started robot 1 patrol');
            window.nav.navigator1.startPatrol([
              {x: 529, y: 198, theta: -0.9323139964404594}, 
              {x: 459, y: 192, theta: -2.6841178056937682}, 
              {x: 453, y: 340, theta: 2.0243940229026687}, 
              {x: 526, y: 343, theta: 0.6564111896256672}
            ]);
          } else {
            this.logs.unshift((new Date()).toTimeString() + ' - Started robot 2 patrol');
            window.nav.navigator2.startPatrol([
              {x: 308, y: 157, theta: -1.3561322886524252}, 
              {x: 105, y: 156, theta: -2.414950312908069},
              {x: 100, y: 329, theta: 1.8516340514160998},
              {x: 303, y: 331, theta: 0.6383801107286253}
            ]);
          }
        }
      },
      mounted() {}
    })

    window.selectedRobotIndex = 0

    // Connect to ROS.
    app.connect();

    // Create the main viewer.
    app.createViewer();

    // Setup the nav client.
    window.nav = NAV2D.OccupancyGridClientNav({
      ros : app.ros,
      rootObject : app.viewer.scene,
      viewer : app.viewer,
      serverName : ['/robot1/move_base', '/robot2/move_base'],
      poseTopicName: ['/robot1/amcl_pose', '/robot2/amcl_pose'],
      poseMessageType: 'geometry_msgs/PoseWithCovarianceStamped',
      withOrientation: true
    });

    window.app = app;
  }
</script>
</head>

<body onload="init()">
  <div id="app">
    <button @click="switchRobot">Switch Robot</button>
    <button @click="startPatrol">Start Patrol</button>
    <div class="container">
      <div class="card" style="margin: 10px 0 10px 0">
        <div class="card-header">
          <h4 class="card-header-title">Navigation</h4>
        </div>
        <div class="card-body text-center">
          <div id="nav" class="d-inline-block"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h4 class="card-header-title">Recent Activity</h4>
        </div>
        <div class="card-body">
          <p v-for="log of logs">{{ log }}</p>
        </div>
      </div>
    </div> 
  </div>
</body>
</html>