<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
  body {
    background-color: #f9fbfd;
  }
  .card {
    border-color: #edf2f9;
    box-shadow: 0 0.75rem 1.5rem rgba(18,38,63,.03);
  }
  .card-header {
    padding: 1rem 1.5rem;
    margin-bottom: 0;
    background-color: transparent;
    border-bottom: 1px solid #edf2f9;
  }
  .card-header-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 0;
  }
  .active {
    border: 1px solid #007bff;
  }
</style>

<script type="text/javascript" src="dependencies/easeljs.min.js"></script>
<script type="text/javascript" src="dependencies/eventemitter2.min.js"></script>
<script type="text/javascript" src="dependencies/roslib.min.js"></script>
<script type="text/javascript" src="dependencies/ros2d.min.js"></script>
<script type="text/javascript" src="dependencies/vuejs.min.js"></script>
<script type="text/javascript" src="navigation.js"></script>

<script type="text/javascript">
  /**
   * Setup all GUI elements when the page is loaded.
   */
  function init() {

    var app = new Vue({
      el: '#app',
      // storing the state of the page
      data: {
          logs: [],
          ws_address: 'ws://localhost:9090',
          conected: false,
          ros: null,
          viewer: null,
          selectedRobotIndex: 0
      },
      methods: {
        connect: function() {
            this.ros = new ROSLIB.Ros({
                url: this.ws_address
            });
            this.ros.on('connection', () => {
                this.logs.unshift({
                  date: (new Date()).toTimeString(),
                  message: 'Connected!'
                });
                this.connected = true
            });
            this.ros.on('error', (error) => {
                this.logs.unshift({
                  date: (new Date()).toTimeString(),
                  message: 'Error: ' + error
                });
            });
            this.ros.on('close', () => {
                this.logs.unshift({
                  date: (new Date()).toTimeString(),
                  message: 'Disconnected!'
                });
                this.connected = false
            });
        },
        createViewer: function() {
          this.viewer = new ROS2D.Viewer({
            divID : 'nav',
            width : 650,
            height : 600
          });
        },
        selectRobot: function(index) {
          this.selectedRobotIndex = index;
          this.logs.unshift({
            date: (new Date()).toTimeString(),
            message: ' Selected robot ' + (index+1)
          });
        },
        startPatrol: function() {
          if(this.selectedRobotIndex === 0) {
            this.logs.unshift({
              date: (new Date()).toTimeString(),
              message: ' Started robot 1 patrol'
            });
            window.nav.navigator1.startPatrol([
              {x: 529, y: 198, theta: -0.9323139964404594}, 
              {x: 459, y: 192, theta: -2.6841178056937682}, 
              {x: 453, y: 340, theta: 2.0243940229026687}, 
              {x: 526, y: 343, theta: 0.6564111896256672}
            ]);
          } else {
            this.logs.unshift({
              date: (new Date()).toTimeString(),
              message: ' Started robot 2 patrol'
            });
            window.nav.navigator2.startPatrol([
              {x: 308, y: 157, theta: -1.3561322886524252}, 
              {x: 105, y: 156, theta: -2.414950312908069},
              {x: 100, y: 329, theta: 1.8516340514160998},
              {x: 303, y: 331, theta: 0.6383801107286253}
            ]);
          }
        }
      },
      mounted() {}
    })

    // Connect to ROS.
    app.connect();

    // Create the main viewer.
    app.createViewer();

    // Setup the nav client.
    window.nav = NAV2D.OccupancyGridClientNav({
      ros : app.ros,
      rootObject : app.viewer.scene,
      viewer : app.viewer,
      serverName : ['/robot1/move_base', '/robot2/move_base'],
      poseTopicName: ['/robot1/amcl_pose', '/robot2/amcl_pose'],
      poseMessageType: 'geometry_msgs/PoseWithCovarianceStamped',
      withOrientation: true
    });

    window.app = app;
  }
</script>
</head>

<body onload="init()">
  <div id="app">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <div class="card" style="margin: 10px 0 10px 0">
            <div class="card-header">
              <h4 class="card-header-title">Navigation</h4>
            </div>
            <div class="card-body text-center">
              <div id="nav" class="d-inline-block"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card" style="margin: 10px 0 10px 0">
            <div class="card-header">
              <h4 class="card-header-title">Robots</h4>
            </div>
            <div class="card-body text-center">
              <div class="card" v-bind:class="[selectedRobotIndex === 0 ? 'active' : '']" style="margin-bottom: 10px; cursor: pointer;" @click="selectRobot(0)">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col">
  
                      <!-- Title -->
                      <h6 class="text-uppercase mb-2 text-left" style="color: orange; letter-spacing: .08em;">
                        Robot 1
                      </h6>
  
                      <p class="text-left" style="margin-bottom: 0;">
                        <span style="color: #95aac9;">Status: </span>
                        <span>patrolling...</span>
                      </p>
                    </div>
                  </div> 
                </div>
              </div>
              <div class="card" v-bind:class="[selectedRobotIndex === 1 ? 'active' : '']" style="margin-bottom: 10px; cursor: pointer;" @click="selectRobot(1)">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col">
  
                      <!-- Title -->
                      <h6 class="text-uppercase mb-2 text-left" style="color: blue; letter-spacing: .08em;">
                        Robot 2
                      </h6>
  
                      <p class="text-left" style="margin-bottom: 0;">
                        <span style="color: #95aac9;">Status: </span>
                        <span>waiting...</span>
                      </p>
                    </div>
                  </div> 
                </div>
              </div>
              <button type="button" class="btn btn-outline-primary" @click="startPatrol">Start patrol</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h4 class="card-header-title">Recent Activity</h4>
        </div>
        <div class="card-body" style="max-height: 200px;overflow: auto;">
          <p v-for="log of logs"><span style="color: gray; font-size: 12px; position: relative; bottom: 2px;">{{ log.date }}</span> - {{ log.message }}</p>
        </div>
      </div>
    </div> 
  </div>
</body>
</html>