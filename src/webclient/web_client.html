<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<link rel="stylesheet" href="dependencies/bootstrap.min.css">
<link rel="stylesheet" href="navigation.css">

<script type="text/javascript" src="dependencies/jquery.min.js"></script>
<script type="text/javascript" src="dependencies/bootstrap.min.js"></script>
<script type="text/javascript" src="dependencies/easeljs.min.js"></script>
<script type="text/javascript" src="dependencies/eventemitter2.min.js"></script>
<script type="text/javascript" src="dependencies/roslib.min.js"></script>
<script type="text/javascript" src="dependencies/ros2d.min.js"></script>
<script type="text/javascript" src="dependencies/vuejs.min.js"></script>
<script type="text/javascript" src="navigation.js"></script>

<script type="text/javascript">
  /**
   * Setup all GUI elements when the page is loaded.
   */
  function init() {

    var app = new Vue({
      el: '#app',
      // storing the state of the page
      data: {
          logs: [],
          occurrences: [],
          ws_address: 'ws://localhost:9090',
          conected: false,
          ros: null,
          viewer: null,
          selectedRobotIndex: 0,
          nav: {}
      },
      methods: {
        connect: function() {
            this.ros = new ROSLIB.Ros({
                url: this.ws_address
            });
            this.ros.on('connection', () => {
                this.logs.unshift({
                  date: (new Date()).toTimeString(),
                  message: 'Connected!'
                });
                this.connected = true
            });
            this.ros.on('error', (error) => {
                this.logs.unshift({
                  date: (new Date()).toTimeString(),
                  message: 'Error: ' + error
                });
            });
            this.ros.on('close', () => {
                this.logs.unshift({
                  date: (new Date()).toTimeString(),
                  message: 'Disconnected!'
                });
                this.connected = false
            });
        },
        createViewer: function() {
          this.viewer = new ROS2D.Viewer({
            divID : 'nav',
            width : 650,
            height : 600
          });
        },
        createOccupancyGridClientNav: function() {
          this.nav = NAV2D.OccupancyGridClientNav({
            ros : app.ros,
            rootObject : app.viewer.scene,
            viewer : app.viewer,
            serverName : ['/robot1/move_base', '/robot2/move_base'],
            poseTopicName: ['/robot1/amcl_pose', '/robot2/amcl_pose'],
            poseMessageType: 'geometry_msgs/PoseWithCovarianceStamped',
            withOrientation: true
          });
        },
        selectRobot: function(index) {
          this.selectedRobotIndex = index;
          this.logs.unshift({
            date: (new Date()).toTimeString(),
            message: ' Selected robot ' + (index+1)
          });
        },
        startPatrol: function(index) {
          this.logs.unshift({
            date: (new Date()).toTimeString(),
            message: ' Started robot ' + (index+1) + ' patrol'
          });
          index === 0 && this.nav.robots[0].startPatrol([
            {x: 529, y: 198, theta: -0.9323139964404594}, 
            {x: 459, y: 192, theta: -2.6841178056937682}, 
            {x: 453, y: 340, theta: 2.0243940229026687}, 
            {x: 526, y: 343, theta: 0.6564111896256672}
          ]);
          index === 1 && this.nav.robots[1].startPatrol([
            {x: 308, y: 157, theta: -1.3561322886524252}, 
            {x: 105, y: 156, theta: -2.414950312908069},
            {x: 100, y: 329, theta: 1.8516340514160998},
            {x: 303, y: 331, theta: 0.6383801107286253}
          ]);
        },
        stopPatrol: function(index) {
          this.nav.robots[index].stopPatrol();
        },
        debug: function() {
          var securityActionClient = new ROSLIB.ActionClient({
            ros : this.ros,
            actionName : 'multi_robots_security_system/SecurityAction',
            serverName : '/security_system'
          });
          console.log(securityActionClient);
          var rootObject = this.nav.robots[0].rootObject;
          var stage = null;
          if (rootObject instanceof createjs.Stage) {
            stage = rootObject;
          } else {
            stage = rootObject.getStage();
          }
          function createPoseMessage(x, y, theta) {
            // convert map coordinates to ROS coordinates
            var coords = stage.globalToRos(x, y);
            var config = {
              position : new ROSLIB.Vector3(coords)
            }
            if(theta) {
              var orientation = getOrientationParams(theta);
              config.orientation = new ROSLIB.Quaternion({x:0, y:0, z: orientation.qz, w: orientation.qw});
            }
            return new ROSLIB.Pose(config);
          }
          var pose1 = createPoseMessage(529, 198);
          var pose2 = createPoseMessage(459, 192);
          var goal = new ROSLIB.Goal({
            actionClient : securityActionClient,
            goalMessage : {
                robotIndex: 0,
                patrol_poses : {
                  header : {
                    frame_id : '/map'
                  },
                  poses : [pose1, pose2]
                }
              }
          });
          console.log(goal);
          goal.send();
        },
        generateOccurrence: function() {
          // report ocurrence on the interface
          $('#alert-occurence').toast('show');
          // select a fake location to put the occurrence
          var navigator = this.nav.robots[0];
          var markerConfig = {
            size : 15,
            strokeSize : 1,
            fillColor : createjs.Graphics.getRGB(255, 0, 0, 0.66),
            pulse : false
          };
          var occurrenceCoordinates = [
            {x: 62, y: 201},
            {x: 299, y: 164},
            {x: 508, y: 158},
            {x: 313, y: 281}
          ];
          var locationIndex =  Math.floor(4 * Math.random());
          var occurrenceLocation = occurrenceCoordinates[locationIndex];
          var poseMessage = navigator.createPoseMessage(occurrenceLocation.x, occurrenceLocation.y);
          var occurrenceMark = navigator.createMarker(poseMessage, markerConfig);
          // put a marker on the map to show where the occurrence is
          navigator.rootObject.addChild(occurrenceMark);
          // save a reference to the mark to make it possible to clear it later
          this.occurrences.push(occurrenceMark);
        },
        clearAllOccurrences: function() {
          var navigator = this.nav.robots[0];
          for(var i=0; i<this.occurrences.length; i++) {
            navigator.rootObject.removeChild(this.occurrences[i]);
          }
        }
      },
      mounted() {}
    })

    // Connect to ROS.
    app.connect();

    // Create the main viewer.
    app.createViewer();

    // Setup the nav client.
    app.createOccupancyGridClientNav();

    // randomly generate occurrences
    window.setInterval(function() {
      var fakeChanceOfOccurrence = Math.random();
      if(fakeChanceOfOccurrence < 0.1) {
        app.generateOccurrence();
      }
    }, 5000);

    // initialize occurence alert container
    $('.toast').toast({
      autohide: false
    });
  
    window.app = app;
  }
</script>
</head>

<body onload="init()">
  <div id="app">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <div class="card" style="margin: 10px 0 10px 0; height: 100%;">
            <div class="card-header">
              <h4 class="card-header-title">Navigation</h4>
            </div>
            <div class="card-body text-center">
              <div id="alert-occurence" style="margin-top: 10px; margin-left: 42px;" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                  <strong class="mr-auto">System</strong>
                  <small>11 mins ago</small>
                  <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="toast-body bg-danger text-white">
                  An occurence has appeared on the map!
                </div>
              </div>
              <div id="nav" class="d-inline-block"></div>
              <div style="height: 0; position: relative; bottom: 250px; text-align: left; margin-left: 42px;">
                <p style="font-weight: bold; font-size: 14px;">Actions</h6>
                <div>
                  <button type="button" class="btn btn-outline-success" @click="clearAllOccurrences" style="width: 200px;">Clear all occurrences</button>
                </div>
                <div>
                  <button type="button" class="btn btn-outline-secondary" style="width: 200px; margin-top: 10px;" disabled>Another action</button>
                </div>
                <div>
                  <button type="button" class="btn btn-outline-secondary" style="width: 200px; margin-top: 10px;" disabled>Another action</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card" style="margin: 10px 0 10px 0; height: 100%;">
            <div class="card-header">
              <h4 class="card-header-title">Robots</h4>
            </div>
            <div class="card-body text-center">
              <p style="text-align: left;color: #bdbdbd;font-size: 14px;"><strong>Hint: </strong>select a robot by clicking its card. Then, click anywhere in the map to send the robot to investigate the location. You can also activate patrol mode on each robot separatly</p>
              <div class="card gray-hover" v-bind:class="[selectedRobotIndex === 0 ? 'active' : '']" style="margin-bottom: 10px; cursor: pointer;" @click="selectRobot(0)">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col">
                      
                      <!-- Title -->
                      <h6 class="text-uppercase mb-2 text-left" style="color: rgb(255, 128, 0); letter-spacing: .08em;">
                        Robot 1
                      </h6>
  
                      <p class="text-left" style="margin-bottom: 0;">
                        <span style="color: #95aac9;">Status: </span>
                        <span class="text-success">Available</span>
                      </p>
                    </div>
                    <div class="col" style="text-align: right;">
                      <img height="50" src="https://cdn1.iconfinder.com/data/icons/robots-avatars-set/354/Robot_chatbot___robot_robo_chatbot_digital_chat_bot-512.png">
                    </div>
                  </div> 
                  <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-outline-primary" @click="startPatrol(selectedRobotIndex)">Start patrol</button>
                  </div>
                  <div style="text-align: left; display: none;">
                    <button type="button" class="btn btn-outline-danger" @click="stopPatrol(selectedRobotIndex)">Stop patrol</button>
                  </div>
                </div>
              </div>
              <div class="card gray-hover" v-bind:class="[selectedRobotIndex === 1 ? 'active' : '']" style="margin-bottom: 10px; cursor: pointer;" @click="selectRobot(1)">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col">
                      
                      <!-- Title -->
                      <h6 class="text-uppercase mb-2 text-left" style="color: rgb(128, 255, 0); letter-spacing: .08em;">
                        Robot 2
                      </h6>
  
                      <p class="text-left" style="margin-bottom: 0;">
                        <span style="color: #95aac9;">Status: </span>
                        <span class="text-success">Available</span>
                      </p>
                    </div>
                    <div class="col" style="text-align: right;">
                      <img height="50" src="https://cdn1.iconfinder.com/data/icons/robots-avatars-set/354/Robot_chatbot___robot_robo_chatbot_digital_chat_bot-512.png">
                    </div>
                  </div> 
                  <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-outline-primary" @click="startPatrol(selectedRobotIndex)">Start patrol</button>
                  </div>
                  <div style="text-align: left; display: none;">
                    <button type="button" class="btn btn-outline-danger" @click="stopPatrol(selectedRobotIndex)">Stop patrol</button>
                  </div>
                </div>
              </div>
              <div style="margin-top: 20px;">
                <button type="button" class="btn btn-outline-info" @click="debug">Debug</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top: 20px;">
        <div class="card-header">
          <h4 class="card-header-title">Recent Activity</h4>
        </div>
        <div class="card-body" style="max-height: 200px;overflow: auto;">
          <p v-for="log of logs"><span style="color: gray; font-size: 12px; position: relative; bottom: 2px;">{{ log.date }}</span> - {{ log.message }}</p>
        </div>
      </div>
    </div> 
  </div>
</body>
</html>